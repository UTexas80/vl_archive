# ------------------------------------------------------------------------------
# Function Archive                                                           ---
# ------------------------------------------------------------------------------
fun_archive <- function(nm){
  
  fun_archive_zip(nm)
  
#...............................................................................
browser()
#...............................................................................

  setwd(valueline_path)
  source(paste0(valueline_path, vl_source))
  
#...............................................................................
browser()
#...............................................................................  

  # setwd(vl_path)  
  }
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------  
fun_archive_zip <- function(nm){
  
#...............................................................................
#  browser()
#...............................................................................
  
# ------------------------------------------------------------------------------
#  download zip file(s)
# ------------------------------------------------------------------------------
  cd$download_file(paste0(dir_ms365_zip, nm[,1]),
                   paste0(zip_file_path, nm[,1]),
                   overwrite = TRUE)
# ------------------------------------------------------------------------------
# chatGPT extract the csv files from the zip file and return a list of file name
# ------------------------------------------------------------------------------
  utils::unzip(
    paste0(zip_file_path, nm[,1]),
    list      = FALSE,
    overwrite = TRUE,
    #   exdir     = here::here("temp")
    exdir     = valueline_path_data,
  )
# ------------------------------------------------------------------------------  
  dt_unzipped_files <<- utils::unzip(
    paste0(zip_file_path, nm[,1]),
    list      = TRUE,
    overwrite = TRUE,
#   exdir     = here::here("temp")
    exdir     = valueline_path_data,
  )$Name
# ------------------------------------------------------------------------------
# dt_file_table[nrow(dt_file_table) + 1, "file_name"] <- file

#...............................................................................
browser()
#...............................................................................
# loop through the list of file names and read each csv file into a data.table
#...............................................................................    
# dt_list <- lapply(csv_files, function(x) {
#   fread(unzip(zip_file, files = x))
# })
# 
# date_run <- read.csv(paste0(here::here("ml//"), str_extract(nm, "[a-zA-Z]+"), ".CSV"))[3,2]
# dt_file_table[name == nm, date_run := date_run]
# ------------------------------------------------------------------------------
# file_table[nrow(file_table) + 1, "date_run"] <- date_run
# test <- setDT(data.table::fread(paste0(here::here("ml//"), str_extract(nm, "[a-zA-Z]+"), ".CSV")))[3,2]
# test <- setDT(data.table::fread(paste0(here::here("ml//"), str_extract(nm, "[a-zA-Z]+"), ".CSV")))
# ------------------------------------------------------------------------------  
}
# ------------------------------------------------------------------------------

