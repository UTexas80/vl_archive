dt1 <- dt[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0)]
dt1
dt2 <- dt[stk_incrmt == 0, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0)]
dt2
dt
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt1 <- dt[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0)]
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt2 <- dt[stk_incrmt == 0, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0)]
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt1 <- dt
dt1 <- dt1[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0),  .I]
dt1
dt2 <- dt
dt2 <- dt[stk_incrmt == 0, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0),  .I]
dt2
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt1 <- dt
dt1 <- dt1[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0),  .I]
dt
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt
dt1 <- dt
dt1 <- dt1[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0),  .I]
dt
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt
View(dt)
View(blob)
dt[, prev_3 := c(NA, 1:(nrow(dt) - 1)) +
cumsum(c(FALSE, shift(OPTKR, type = "lag", n = 1L) != "")) *
as.integer(OPTKR == ""), .SDcols = c("OPTKR")]
dt
dt[, prev_3 := c(NA, 1:(nrow(dt) - 1)) +
cumsum(c(FALSE, shift(OPTKR, type = "lag", n = 1L) != "")) *
as.integer(OPTKR == ""),  , by = .(TKR, dt[[2]], EXPDAY), .SDcols = c("OPTKR")]
dt
t<- dt
t[, prev_2 := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0), .SDcols = c("OPTKR"), .I]
t[, prev_2 := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0), .I]
dt
dt <- dt[,-6]
dt
t1 <- dt
t1
t1[, prev_1 := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0), .I]
t1
t
dt
t3<-dt
t3[, prev_3 := ifelse(shift(OPTKR, type = "lag", n = 3L) == "", 3, 0), .I]
dt
t3
dt[,-6]
rm(t3)
t3<-dt
t3
dt
dt[,-c(6:7)]
t3 <- dt
t3
dt
t3 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t3
t3[, prev_3 := ifelse(shift(OPTKR, type = "lag", n = 3L) == "", 3, 0), .I]
t2
t
t1
t1 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t1[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 1L) == "", 1, 0), .I]
t2 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t2[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 2L) == "", 2, 0), .I]
t3 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t3[, stk_incrmt := ifelse(shift(OPTKR, type = "lag", n = 3L) == "", 3, 0), .I]
t_1 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t_1[, stk_incrmt := ifelse(shift(OPTKR, type = "lead", n = 1L) == "", 1, 0), .I]
t_2 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t_2[, stk_incrmt := ifelse(shift(OPTKR, type = "lead", n = 2L) == "", 2, 0), .I]
rm(t_1, t_2)
t_1 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t_1[, stk_incrmt := ifelse(shift(OPTKR, type = "lead", n = 1L) == "", -1, 0), .I]
t_2 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t_2[, stk_incrmt := ifelse(shift(OPTKR, type = "lead", n = 2L) == "", -2, 0), .I]
t_3 <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
t_3[, stk_incrmt := ifelse(shift(OPTKR, type = "lead", n = 2L) == "", -3, 0), .I]
t1[stk_incrmt==1,]
rbind(t1[stk_incrmt==1,], t2[stk_incrmt==2,], t3[stk_incrmt==3,],t_1[stk_incrmt== -1,], t_2[stk_incrmt== -2,], t_3[stk_incrmt== -3,])
test <- rbind(t1[stk_incrmt==1,], t2[stk_incrmt==2,], t3[stk_incrmt==3,],t_1[stk_incrmt== -1,], t_2[stk_incrmt== -2,], t_3[stk_incrmt== -3,])
test
test[OPTKR != "",]
tx <- setorder(test, OPTKR, stk_incrmt)
tx
tx[TKR == 'AA',]
unique(tx[TKR == 'AA',])
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
dt
DT = data.table(grp=rep(c("A", "B", "C", "A", "B"), c(2,2,3,1,2)), value=1:10)
rleid(DT$grp) # get run-length ids
rleidv(DT, "grp") # same as above
DT
dt
DT[, sum(value), by=.(grp, rleid(grp))]
rleidv(dt,  by = .(TKR, dx_tkr_stk[[2]], EXPDAY))
dt[, .I,  by = .(TKR, dx_tkr_stk[[2]], EXPDAY)]
dt[, .I,  by = .(TKR, dt[[2]], EXPDAY)]
dt[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY)]
dt[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY), rleid(STRIKE)]
dt[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(STRIKE))]
dt[, .N,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(STRIKE))]
dt
dt[, .N,  by = .(OPTKR, rleid(STRIKE))]
dt[, .I,  by = .(OPTKR, rleid(STRIKE))]
DT[, sum(value), by=.(grp, rleid(grp, prefix="grp"))
# ------------------------------------------------------------------------------
df <- rbind(
dt1[ stk_incrmt ==  1,],
dt2[ stk_incrmt ==  2,],
dt3[ stk_incrmt ==  3,],
dt_1[stk_incrmt == -1,],
dt_2[stk_incrmt == -2,],
dt_3[stk_incrmt == -3,]
)
DT = data.table(grp=rep(c("A", "B", "C", "A", "B"), c(2,2,3,1,2)), value=1:10)
rleid(DT$grp) # get run-length ids
rleidv(DT, "grp") # same as above
rleid(DT$grp, prefix="grp") # prefix with 'grp'
# get sum of value over run-length groups
DT[, sum(value), by=.(grp, rleid(grp))]
DT[, sum(value), by=.(grp, rleid(grp, prefix="grp"))]
DT[, sum(value), by=.c(grp, rleid(grp, prefix="grp"))
DT[, sum(value), by=.c(grp, rleid(grp, prefix="grp")))
DT[, sum(value), by=.c(grp, rleid(grp, prefix="grp"))
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY, rleid(STRIKE))]
dt[, .I,  by = .(TKR, dt[[2]], EXPDAY, rleid(STRIKE))]
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY, STRIKE)]
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY)]
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY)][N>4,]
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY, rleid(TKR, STRIKE, EXPDAY))]
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY, rleid(TKR, dt[[2]], STRIKE, EXPDAY))]
dt
dz <- dt[,-4]
dz
dz[, .N,  by = .(TKR, dt[[2]], EXPDAY, rleid(TKR, dt[[2]], STRIKE, EXPDAY))]
dz[, .N,  by = .(TKR, dt[[2]], EXPDAY, rleid(TKR, dt[[2]], EXPDAY))]
dz[, .I,  by = .(TKR, dt[[2]], EXPDAY, rleid(TKR, dt[[2]], EXPDAY))]
dz[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(TKR, dt[[2]], EXPDAY))]
dz[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(TKR, dt[[2]]))]
dz[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(TKR))]
dz[, .I,  by = .(TKR, rleid(TKR))]
dz[, .I,  by = .(TKR, dt[[2]], rleid(TKR))]
dz[, .I,  by = .(TKR, dt[[2]], STRIKE, rleid(TKR))]
dz[, .I,  by = .(TKR, dt[[2]], STRIKE, EXPDAY, rleid(TKR))]
dt[order(TKR, EXPDAY, 'C/P', STRIKE), group := rleid(TKR, dt[[2]], EXPDAY,)]
dt[order(TKR, EXPDAY, 'C/P', STRIKE), group := rleid(TKR, dt[[2]], EXPDAY)]
dt[order(TKR, EXPDAY, 'C/P', STRIKE), group := rleid(TKR)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, EXPDAY, STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, EXPDAY, 'C/P', STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, EXPDAY, "'C/P'", STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, EXPDAY, dt[[2]], STRIKE)]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, EXPDAY, dt[[2]])]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, dt[[2]])]
dt[order(TKR, EXPDAY,  STRIKE), group := rleid(TKR, STRIKE, dt[[2]])]
dt[, stk_incrmt := fcase(
shift(OPTKR, type = "lag",  n = 1L) ==  1,
shift(OPTKR, type = "lead", n = 1L) == -1,
shift(OPTKR, type = "lag",  n = 2L) ==  2,
shift(OPTKR, type = "lead", n = 2L) == -2,
shift(OPTKR, type = "lag",  n = 3L) ==  3,
shift(OPTKR, type = "lead", n = 3L) == -3,
), .SDcols = c("OPTKR"), .I]
l<-dt
l
l[,-6]
l
l<-l[,-6]
l <- setorder(l, TKR, sEXPDAY, 'C/P', STRIKE)
l <- setorder(l, TKR, EXPDAY, 'C/P', STRIKE)
l
l[, strike_prev := shift(STRIKE)]
l[, strike_prev_2 := shift(STRIKE, type = "lag", n = 2)]
l[, strike_next := shift(STRIKE, type = "lead")]
l[, strike_next_2 := shift(STRIKE, type = "lead", n = 2)]
l
l[OPTKR=="",]
na.omit(l)
na.omit(l[OPTKR=="",])
l[l[[2]=='P', strike_prev := shift(STRIKE)]
l[l[[2]]=='P', strike_prev := shift(STRIKE)]
l[l[[2]]=='P',]
l[l[[2]]=='P',][, strike_prev := shift(STRIKE)]
l[l[[2]]=='P',][, strike_0 := shift(STRIKE)]
l[l[[2]]=='P',][, strike_0 := shift(STRIKE, type = 'lag')]
l[l[[2]]=='P',][, strike_00 := shift(STRIKE, type = 'lag')]
l[l[[2]]=='P',][, strike_0 := shift(STRIKE, type = 'lead')]
rm(l)
dt <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
l <- dt
l[l[[2]]=='P',][, c(strike_lead0P := shift(STRIKE, type = 'lead'), strike_lag0 := shift(STRIKE, type = 'lag')]
l[l[[2]]=='P',][, c(strike_lead0P := shift(STRIKE, type = 'lead'), strike_lag0 := shift(STRIKE, type = 'lag'))]
l
l[l[[2]]=='P',][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag')))]
l[l[[2]]=='P',][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))]
l[TKR=='AA',]
l[l[[2]]=='P',][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))][TKR=='AA',]
l[l[[2]]=='C',][, c("strike_lead_0_C", "strike_lag_0_C") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))][TKR=='AA',]
l[l[[2]]=='C',][, c("strike_lead_0_C", "strike_lag_0_C", "strike_lead_1_C") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'),shift(STRIKE, type = "lead", n = 2))][TKR=='AA',]
l[l[[2]]=='C',][, c("strike_lead_0_C", "strike_lag_0_C", "strike_lead_1_C") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'),shift(STRIKE, type = "lead", n = 2))][TKR=='AA' & OPTKR == "",]
l[l[[2]]=='P',][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))][TKR=='AA',]
source("~/github/vl_archive/vl_archive.r", echo=TRUE)
renv::status()
renv::snapshot()
renv::status()
pak::pkg_install('gaborcsardi/async')
pak::pkg_install('AustralianAntarcticDivision/bgmfiles')
pak::pkg_install('ianjonsen/bsam')
renv::status()
taskscheduleR:::taskschedulerAddin()
source("~/github/vl_archive/vl_archive.r", echo=TRUE)
View(dx_tkr_stk)
viewxl:::view_in_xl()
View(s_minus_1)
viewxl:::view_in_xl()
renv::status()
renv::snapshot()
renv::status()
renv::snapshot()
pak::pkg_install('rich-iannone/pointblank')
renv::status()
pak::pkg_install('nteetor/zeallot')
renv::status()
renv::snapshot()
source("~/github/vl_archive/vl_archive.r", echo=TRUE)
glimpse(dx_stk)
View(dx_stk)
dt[, .N,  by = .(TKR, dt[[2]], EXPDAY)][N>4,]
dt_stk[, .N,  by = .(TKR, dt[[2]], EXPDAY)][N>4,]
dx_stk[, .N,  by = .(TKR, dt[[2]], EXPDAY)][N>4,]
dx_stk[, .N,  by = .(TKR, dx_stk[[2]], EXPDAY)][N>4,]
l <- dx_stk
l[l[[2]]=='P',by = .(TKR, l[[2]], EXPDAY)][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))][TKR=='AA',]
l[l[[2]]=='C',by = .(TKR, l[[2]], EXPDAY][, c(
# ------------------------------------------------------------------------------lag_1_c
"lag_1_optkr",
"lag_1_stk",
"lag_1_pct_chg",
# ------------------------------------------------------------------------------lag_0_c
"lag_0_optkr",
"lag_0_stk",
"lag_0_pct_chg",
# ------------------------------------------------------------------------------lead_0_c
"lead_0_optkr",
"lead_0_stk",
"lead_0_pct_chg",
# ------------------------------------------------------------------------------
"lead_1_optkr",
"lead_1_stk",
"lead_1_pct_chg") :=
# ------------------------------------------------------------------------------lag_1_c
.(shift(OPTKR,    type = 'lag', n = 2),
shift(STRIKE,   type = 'lag', n = 2),
(STRIKE - shift(STRIKE, type = "lag", n = 2)) /
shift(STRIKE, type = "lag", n = 2) * 100,
# ------------------------------------------------------------------------------lag_0_c
shift(OPTKR,    type = 'lag', n = 1),
shift(STRIKE,   type = 'lag', n = 1),
(STRIKE - shift(STRIKE, type = "lag", n = 1)) /
shift(STRIKE, type = "lag", n = 1) * 100,
# ------------------------------------------------------------------------------lead_0_c
shift(OPTKR,    type = 'lead', n = 1),
shift(STRIKE,   type = 'lead', n = 1),
(STRIKE - shift(STRIKE, type = "lead", n = 1)) /
shift(STRIKE, type = "lead", n = 1) * 100,
# ------------------------------------------------------------------------------lead_1_c
shift(OPTKR,    type = "lead", n = 2),
shift(STRIKE,   type = "lead", n = 2),
(STRIKE - shift(STRIKE, type = "lead", n = 2)) /
shift(STRIKE, type = "lead", n = 2) * 100
)][
TKR=='AA' & OPTKR == "",]
l[l[[2]]=='C',by = .(TKR, l[[2]], EXPDAY]
l[l[[2]]=='P',by = .(TKR, l[[2]], EXPDAY)][, c("strike_lead_0_P", "strike_lag_0_P") := .(shift(STRIKE, type = 'lead'), shift(STRIKE, type = 'lag'))][TKR=='AA',]
l
l <- dx_stk
l <- data.table::setorder(
rbind(
rbind(dx_ticker[dx_tkr_stk, on = .(TKR), roll = Inf, nomatch = 0][
, by = .(TKR, dx_tkr_stk[[2]], EXPDAY), .SD[.N]][
, c("STRIKE", "OPTKR") := .(CMPRICE, "")][
,c(1,5:7,3)]),
dx_tkr_stk),
TKR, EXPDAY, 'C/P', STRIKE
)
l[l[[2]]=='C', by = .(TKR, dt[[2]], EXPDAY]
l[l[[2]]=='C', by = .(TKR, dt[[2]], EXPDAY)]
l[l[[2]]=='C', by = .(TKR, dt[[2]], EXPDAY)][, c(
# ------------------------------------------------------------------------------lag_1_c
"lag_1_optkr",
"lag_1_stk",
"lag_1_pct_chg",
# ------------------------------------------------------------------------------lag_0_c
"lag_0_optkr",
"lag_0_stk",
"lag_0_pct_chg",
# ------------------------------------------------------------------------------lead_0_c
"lead_0_optkr",
"lead_0_stk",
"lead_0_pct_chg",
# ------------------------------------------------------------------------------
"lead_1_optkr",
"lead_1_stk",
"lead_1_pct_chg") :=
# ------------------------------------------------------------------------------lag_1_c
.(shift(OPTKR,    type = 'lag', n = 2),
shift(STRIKE,   type = 'lag', n = 2),
(STRIKE - shift(STRIKE, type = "lag", n = 2)) /
shift(STRIKE, type = "lag", n = 2) * 100,
# ------------------------------------------------------------------------------lag_0_c
shift(OPTKR,    type = 'lag', n = 1),
shift(STRIKE,   type = 'lag', n = 1),
(STRIKE - shift(STRIKE, type = "lag", n = 1)) /
shift(STRIKE, type = "lag", n = 1) * 100,
# ------------------------------------------------------------------------------lead_0_c
shift(OPTKR,    type = 'lead', n = 1),
shift(STRIKE,   type = 'lead', n = 1),
(STRIKE - shift(STRIKE, type = "lead", n = 1)) /
shift(STRIKE, type = "lead", n = 1) * 100,
# ------------------------------------------------------------------------------lead_1_c
shift(OPTKR,    type = "lead", n = 2),
shift(STRIKE,   type = "lead", n = 2),
(STRIKE - shift(STRIKE, type = "lead", n = 2)) /
shift(STRIKE, type = "lead", n = 2) * 100
)][
TKR=='AA' & OPTKR == "",]
l[l[[2]]=='P', by = .(TKR, dt[[2]], EXPDAY)][, c(
# ------------------------------------------------------------------------------lag_1_c
"lag_1_optkr",
"lag_1_stk",
"lag_1_pct_chg",
# ------------------------------------------------------------------------------lag_0_c
"lag_0_optkr",
"lag_0_stk",
"lag_0_pct_chg",
# ------------------------------------------------------------------------------lead_0_c
"lead_0_optkr",
"lead_0_stk",
"lead_0_pct_chg",
# ------------------------------------------------------------------------------
"lead_1_optkr",
"lead_1_stk",
"lead_1_pct_chg") :=
# ------------------------------------------------------------------------------lag_1_c
.(shift(OPTKR,    type = 'lag', n = 2),
shift(STRIKE,   type = 'lag', n = 2),
(STRIKE - shift(STRIKE, type = "lag", n = 2)) /
shift(STRIKE, type = "lag", n = 2) * 100,
# ------------------------------------------------------------------------------lag_0_c
shift(OPTKR,    type = 'lag', n = 1),
shift(STRIKE,   type = 'lag', n = 1),
(STRIKE - shift(STRIKE, type = "lag", n = 1)) /
shift(STRIKE, type = "lag", n = 1) * 100,
# ------------------------------------------------------------------------------lead_0_c
shift(OPTKR,    type = 'lead', n = 1),
shift(STRIKE,   type = 'lead', n = 1),
(STRIKE - shift(STRIKE, type = "lead", n = 1)) /
shift(STRIKE, type = "lead", n = 1) * 100,
# ------------------------------------------------------------------------------lead_1_c
shift(OPTKR,    type = "lead", n = 2),
shift(STRIKE,   type = "lead", n = 2),
(STRIKE - shift(STRIKE, type = "lead", n = 2)) /
shift(STRIKE, type = "lead", n = 2) * 100
)][
TKR=='AA' & OPTKR == "",]
Q
